name: Deploy to HuggingFace Spaces

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout the GitHub repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # Setup Python for huggingface_hub
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Install huggingface_hub for uploading
      - name: Install huggingface_hub
        run: pip install --upgrade huggingface_hub

      # Upload all files to HuggingFace Space
      - name: Deploy to HuggingFace
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python3 << 'EOF'
          from huggingface_hub import HfApi
          import os

          api = HfApi(token=os.environ["HF_TOKEN"])
          repo_id = "tekadevaibhav/flykit-hr-chatbot"

          # All individual files to upload
          files_to_upload = [
              "app.py",
              "gui.py",
              "Dockerfile",
              "start.sh",
              "docker-compose.yml",
              "Dockerfile.backend",
              "Dockerfile.frontend",
              "requirements.backend.txt",
              "requirements.frontend.txt",
          ]

          # Upload each file one by one
          for f in files_to_upload:
              if os.path.exists(f):
                  api.upload_file(
                      path_or_fileobj=f,
                      path_in_repo=f,
                      repo_id=repo_id,
                      repo_type="space"
                  )
                  print(f"Uploaded: {f}")

          # Upload folders (ChromaDB vectorstore and sample data)
          for folder in ["flykite_hr_vectordb", "sample_data"]:
              if os.path.exists(folder):
                  api.upload_folder(
                      folder_path=folder,
                      path_in_repo=folder,
                      repo_id=repo_id,
                      repo_type="space"
                  )
                  print(f"Uploaded folder: {folder}")

          print("Deployment complete.")
          EOF
